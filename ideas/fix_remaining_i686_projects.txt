Fix remaining i686 project failures
=====================================
Date: 2026-01-28 (updated after Copy I64 const wide marking fix)

Current status:
- Unit tests: ~99.7% pass (10% sample: 2728/2737)
- Projects passing: 7/12 (zlib, lua, libpng, jq, libjpeg, libuv, tcc*)
  * tcc build succeeds; test suite fails due to missing i686 CRT/headers (same as GCC)
- Projects failing: libsodium, mquickjs, mbedtls, libffi, musl

Fixed in latest round (Copy I64 const wide marking fix):
- tcc BUILD now succeeds (was failing in alloca86_64.S assembly)
  - Root cause: IrConst::I64 is the universal container for ALL integer constants,
    but codegen was marking Copy from ANY IrConst::I64 as "wide" (64-bit) on i686.
    This caused 32-bit int variables to be treated as 64-bit, with uninitialized
    upper 32 bits making `if (0)` evaluate as true.
  - Fix: only mark IrConst::I64 as wide when value doesn't fit in 32 bits
- libjpeg now fully passes on i686 (was "Bogus virtual array access")
  - Same root cause: miscompiled array index checks due to wide marking bug

Previously fixed (inline asm typed register load fix):
- libsodium now BUILDS (was failing with "operand size mismatch for `movzw'")
- The issue was movzwl/movsbl/movswl used 16/8-bit dest registers in inline asm
- Runtime tests still fail (segfaults and timeouts in crypto operations)

Known remaining issues:

1. mquickjs: SIGSEGV in js_string_compare during JS parsing
   - Crashes in get_string_ptr -> JS_VALUE_TO_PTR returning garbage pointer
   - JSValue is uint32_t on i686, pointer tagged with low bits
   - val=0x236 -> ptr = val-1 = 0x235, which is not a heap pointer
   - Root cause: likely corruption during JSValueArray access or value passing
   - Needs deep debugging to find where the corruption occurs

2. sqlite: SIGSEGV in columnTypeImpl (0/622 tests pass)
   - Crashes dereferencing NULL struct pointer + offset 0x1c
   - Pattern: pTab=NULL, then pTab->field crashes
   - May share root cause with mquickjs (struct/pointer codegen issue)

3. musl: 3/6 tests pass (hello, string_ops, math pass)
   - malloc test: malloc returns NULL despite brk() succeeding
   - io test: tmpfile() fails (likely related to mmap)
   - environ test: setenv/getenv broken (returns "fail")
   - Built musl has __udivdi3/__umoddi3 deps (satisfied by -lgcc)

4. libsodium: Build succeeds, 0/7 tests pass
   - sodium_init() hangs/segfaults in some tests
   - Random test crashes immediately (SIGSEGV)

5. libjpeg: FIXED (both tests now pass after Copy I64 const wide fix)

6. mbedtls: Build fails (__builtin_ia32_pshufd not implemented)
   - Needs SSE2 intrinsic: _mm_shuffle_epi32 -> __builtin_ia32_pshufd
   - Used in AES-NI key schedule (aesni_set_rk_128/192/256)

7. libffi: Build succeeds, 0/6 tests pass (all SIGSEGV)
   - All FFI call tests crash
   - Likely i686 ABI/calling convention issue in libffi's closure/trampoline code

8. tcc: FIXED (build succeeds after Copy I64 const wide fix)
   - TCC build succeeds but test suite fails due to missing i686 CRT/headers
   - This is a system configuration issue (same with GCC), not a compiler bug

Unit test failure categories:
- Complex number tests (SIGSEGV) - fix_complex_comparison_i64_type being worked on
- Stack alignment >8 bytes: _Alignas(16+) not working for stack vars on i686
- Integer constant overflow: large UL constants not promoted to ULL on ILP32

Priority investigation targets:
- mquickjs/sqlite crashes likely share a common codegen root cause
- Stack _Alignas(>=16) support for i686
- musl malloc failure (mmap-related?)

Techniques:
- Compare i686 assembly output against i686-linux-gnu-gcc for suspect functions
- Use GDB to trace execution and find divergence points
- strace to check syscall behavior for musl failures
